<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Pvec (pvec.Pvec)</title><link rel="stylesheet" href="../../_odoc_support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../_odoc_support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../index.html">pvec</a> &#x00BB; Pvec</nav><header class="odoc-preamble"><h1>Module <code><span>Pvec</span></code></h1><p>Persistent vectors based on bitwise tries.</p></header><nav class="odoc-toc"><ul><li><a href="#basics">Basics</a></li><li><a href="#unsafe-of-get-and-set">Unsafe of get and set</a></li><li><a href="#iterators">Iterators</a></li><li><a href="#converters">Converters</a></li><li><a href="#custom">Custom vectors</a></li></ul></nav><div class="odoc-content"><p>This module implements vectors that</p><ul><li>store <code>n</code> elements with keys ranging from <code>0</code> to <code>n-1</code> like <code>array</code>,</li><li>support efficient random read and write access (almost) like <code>array</code>,</li><li>are persistent (= immutable) like <code>list</code> or <code>Map.t</code>, and</li><li>and grow dynamically like <code>list</code> or <code>Map.t</code>.</li></ul><p>The implementation is based on bitwise tries. Roughly speaking, vector elements are stored in the leaves of a balanced tree and the bitwise representation of an element's index defines the path to the element in the tree. The trie uses a default branching factor of 32 (you can configure something else, see <a href="#custom">Custom vectors</a>). Thus a vector with n elements implies trie-depth log<sub>32</sub>(n). This makes lookups and modifications quasi constant time. To further speed up (series of) appends, <code>Pvec.t</code> batches appended elements into groups of 32 before descending into the tree.</p><p>If you want to know more, I recommend reading <a href="https://hypirion.com/musings/understanding-persistent-vector-pt-1">hyPiRion's series of blog posts about this data-type</a>. It was my main source during implementation. Another source was the <a href="https://github.com/clojure/clojure/blob/master/src/jvm/clojure/lang/PersistentVector.java">Java-implementation of Clojure's persistent vectors</a>.</p><p><b>Disclaimer</b></p><p>I'm solo programming for fun and research. Nobody reviewed my code. My <a href="https://github.com/pkel/pvec/blob/main/test.ml">tests</a> should cover most parts, but bugs might still be lurking. I think my persistent vectors will be useful for others, but I recommend reviewing the code before putting any stake on it. Luckily, it's only a few lines of code. If you review the code, please consider providing feedback.</p><p><b>Related OCaml stuff</b></p><ul><li>The <a href="https://opam.ocaml.org/packages/vector/">vector</a> library provides dynamically growing and mutable arrays.</li><li>The <a href="https://opam.ocaml.org/packages/vec/">vec</a> library provides dynamically growing, mutable, and permission controlled arrays.</li><li>The <a href="https://c-cube.github.io/ocaml-containers/last/containers-data/CCFun_vec/index.html">containers</a> library provides (among many others) a persistent vector similar to <code>pvec</code>. It's marked <i>«experimental. DO NOT USE (yet)»</i>.</li></ul><h2 id="basics"><a href="#basics" class="anchor"></a>Basics</h2><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span></code></div><div class="spec-doc"><p>Persistent vectors with elements of type <code>'a</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-length"><a href="#val-length" class="anchor"></a><code><span><span class="keyword">val</span> length : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>length v</code> returns the number of elements in vector <code>v</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-empty"><a href="#val-empty" class="anchor"></a><code><span><span class="keyword">val</span> empty : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>empty ()</code> returns a new vector of length 0.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span>int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>init n f</code> returns a vector of length <code>n</code> holding the elements <code>f(0)</code>, <code>f(1)</code>, ... .</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-append"><a href="#val-append" class="anchor"></a><code><span><span class="keyword">val</span> append : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>append x v</code> appends <code>x</code> to the end of vector <code>v</code> and returns the updated vector.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set"><a href="#val-set" class="anchor"></a><code><span><span class="keyword">val</span> set : <span>int <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> option</span></span></code></div><div class="spec-doc"><p><code>set i x v</code> replaces the i-th element of vector <code>v</code> with <code>x</code> and returns the updated vector. For <code> i = length v</code>, <code>set i x v</code> equals <code>append x v</code>.</p><p>Returns <code>None</code> if index <code>i</code> is out of bounds.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get"><a href="#val-get" class="anchor"></a><code><span><span class="keyword">val</span> get : <span>int <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>get i v</code> reads the i-th element from vector <code>v</code>.</p><p>Returns <code>None</code> if index <code>i</code> is out of bounds.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-peek"><a href="#val-peek" class="anchor"></a><code><span><span class="keyword">val</span> peek : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>peek v</code> returns the last element of vector <code>v</code> or <code>None</code> if <code>v</code> is empty.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pop"><a href="#val-pop" class="anchor"></a><code><span><span class="keyword">val</span> pop : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'a</span> * <span><span class="type-var">'a</span> <a href="#type-t">t</a></span>)</span> option</span></span></code></div><div class="spec-doc"><p><code>pop v</code> removes the last element of vector <code>v</code> and returns the removed element together with the updated vector.</p><p>Returns <code>None</code> if <code>v</code> is empty.</p></div></div><h2 id="unsafe-of-get-and-set"><a href="#unsafe-of-get-and-set" class="anchor"></a>Unsafe of get and set</h2><div class="odoc-spec"><div class="spec value anchored" id="val-get_exn"><a href="#val-get_exn" class="anchor"></a><code><span><span class="keyword">val</span> get_exn : <span>int <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>get_exn</code> is similar to <a href="#val-get"><code>get</code></a> but raises <code>Not_found</code> instead of returning <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_exn"><a href="#val-set_exn" class="anchor"></a><code><span><span class="keyword">val</span> set_exn : <span>int <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>set_exn</code> is similar to <a href="#val-set"><code>set</code></a> but raises <code>Invalid_argument _</code> instead of returning <code>None</code>.</p></div></div><h2 id="iterators"><a href="#iterators" class="anchor"></a>Iterators</h2><div class="odoc-spec"><div class="spec value anchored" id="val-map"><a href="#val-map" class="anchor"></a><code><span><span class="keyword">val</span> map : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p>Like <code>List</code>.map.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mapi"><a href="#val-mapi" class="anchor"></a><code><span><span class="keyword">val</span> mapi : <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p>Like <code>List</code>.mapi.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fold_left"><a href="#val-fold_left" class="anchor"></a><code><span><span class="keyword">val</span> fold_left : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Like <code>List</code>.fold_left.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fold_right"><a href="#val-fold_right" class="anchor"></a><code><span><span class="keyword">val</span> fold_right : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p>Similar to <code>List</code>.fold_right but does not allocate additional memory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-iter"><a href="#val-iter" class="anchor"></a><code><span><span class="keyword">val</span> iter : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Like <code>List</code>.iter.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rev_iter"><a href="#val-rev_iter" class="anchor"></a><code><span><span class="keyword">val</span> rev_iter : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Like <a href="#val-iter"><code>iter</code></a> but in reverse order.</p></div></div><h2 id="converters"><a href="#converters" class="anchor"></a>Converters</h2><div class="odoc-spec"><div class="spec value anchored" id="val-to_seq"><a href="#val-to_seq" class="anchor"></a><code><span><span class="keyword">val</span> to_seq : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span></span></code></div><div class="spec-doc"><p><code>to_seq v</code> iterates over vector <code>v</code> front-to-back.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rev_to_seq"><a href="#val-rev_to_seq" class="anchor"></a><code><span><span class="keyword">val</span> rev_to_seq : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span></span></code></div><div class="spec-doc"><p><code>rev_to_seq v</code> iterates over vector <code>v</code> back-to-front.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_seq"><a href="#val-of_seq" class="anchor"></a><code><span><span class="keyword">val</span> of_seq : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>of_seq s</code> stores the elements of sequence <code>s</code> in a vector.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_list"><a href="#val-to_list" class="anchor"></a><code><span><span class="keyword">val</span> to_list : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> list</span></span></code></div><div class="spec-doc"><p><code>to_list v</code> converts vector <code>v</code> to a list.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rev_to_list"><a href="#val-rev_to_list" class="anchor"></a><code><span><span class="keyword">val</span> rev_to_list : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> list</span></span></code></div><div class="spec-doc"><p><code>rev_to_list v</code> converts vector <code>v</code> to a list; reverse order.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_list"><a href="#val-of_list" class="anchor"></a><code><span><span class="keyword">val</span> of_list : <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>of_list v</code> converts list <code>l</code> to a vector.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_array"><a href="#val-to_array" class="anchor"></a><code><span><span class="keyword">val</span> to_array : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> array</span></span></code></div><div class="spec-doc"><p><code>to_array v</code> converts vector <code>v</code> to an array.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rev_to_array"><a href="#val-rev_to_array" class="anchor"></a><code><span><span class="keyword">val</span> rev_to_array : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> array</span></span></code></div><div class="spec-doc"><p><code>rev_to_array v</code> converts vector <code>v</code> to an array; reverse order.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_array"><a href="#val-of_array" class="anchor"></a><code><span><span class="keyword">val</span> of_array : <span><span><span class="type-var">'a</span> array</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>of_array v</code> converts array <code>l</code> to a vector.</p></div></div><h2 id="custom"><a href="#custom" class="anchor"></a>Custom vectors</h2><p>The default vector <a href="#type-t"><code>t</code></a> uses branching factor 32. You may create vectors with custom branching factors. After doing</p><pre class="language-ocaml"><code>module V = Pvec.Make (struct
  let branching_factor_log2 = n
end)</code></pre><p>module <code>V</code> has the same interface as <a href="#"><code>Pvec</code></a> but its vectors use branching factor 2<sup>n</sup>.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Make"><a href="#module-Make" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Make/index.html">Make</a></span><span> (<a href="Make/argument-1-_/index.html">_</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span>) : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Persistent vectors with custom branching factor.</p></div></div></div></body></html>